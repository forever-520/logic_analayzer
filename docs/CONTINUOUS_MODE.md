# ğŸ”„ è¿ç»­é‡‡æ ·æ¨¡å¼ä¿®æ”¹è¯´æ˜

## âœ… å·²ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**ï¼š[src/logic_analyzer_core.v](../src/logic_analyzer_core.v#L208-L224)

**ä¿®æ”¹å‰**ï¼ˆå•æ¬¡é‡‡æ ·æ¨¡å¼ï¼‰ï¼š
```verilog
DONE: begin
    wr_en        <= 1'b0;
    capturing    <= 1'b0;
    capture_done <= 1'b1;

    if (!trigger_enable) begin
        state <= IDLE;
        edge_triggered_latch <= 0;
    end
    // âŒ åœç•™åœ¨ DONE çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯
end
```

**ä¿®æ”¹å**ï¼ˆè¿ç»­å¾ªç¯æ¨¡å¼ï¼‰ï¼š
```verilog
DONE: begin
    wr_en        <= 1'b0;
    capturing    <= 1'b0;
    capture_done <= 1'b1;

    if (!trigger_enable) begin
        state <= IDLE;
        edge_triggered_latch <= 0;
    end else begin
        // âœ… è‡ªåŠ¨å¾ªç¯ï¼šå®Œæˆåç«‹å³å›åˆ° WAIT_TRIGGER çŠ¶æ€
        state <= WAIT_TRIGGER;
        triggered    <= 1'b0;        // æ¸…é™¤è§¦å‘æ ‡å¿—
        capture_done <= 1'b0;        // æ¸…é™¤å®Œæˆæ ‡å¿—
        edge_triggered_latch <= 0;   // æ¸…é™¤è¾¹æ²¿é”å­˜
    end
end
```

---

## ğŸ¯ å·¥ä½œæ¨¡å¼å¯¹æ¯”

### åŸå§‹æ¨¡å¼ï¼šå•æ¬¡é‡‡æ ·

```
çŠ¶æ€æµç¨‹ï¼š
IDLE â†’ WAIT_TRIGGER â†’ POST_CAPTURE â†’ DONE (åœæ­¢)
  â†‘                                     â†“
  â””â”€â”€â”€â”€â”€â”€â”€ éœ€è¦æŒ‰ä¸¤æ¬¡ RUN æŒ‰é’® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç²¾ç¡®æ•è·å•æ¬¡äº‹ä»¶
- âœ… capture_done ä¿¡å·ä¿æŒé«˜ç”µå¹³ï¼Œä¾¿äºè§‚å¯Ÿ
- âŒ éœ€è¦æ‰‹åŠ¨é‡æ–°å¯åŠ¨
- âŒ æ¯æ¬¡åªèƒ½é‡‡æ ·ä¸€æ¬¡

**é€‚ç”¨åœºæ™¯**ï¼š
- è°ƒè¯•å•æ¬¡è§¦å‘äº‹ä»¶
- éœ€è¦ä»”ç»†åˆ†æå•æ¬¡é‡‡æ ·æ•°æ®
- UART å‘é€å®Œæˆåéœ€è¦åœæ­¢

---

### æ–°æ¨¡å¼ï¼šè¿ç»­å¾ªç¯é‡‡æ · â­

```
çŠ¶æ€æµç¨‹ï¼š
IDLE â†’ [WAIT_TRIGGER â†’ POST_CAPTURE â†’ DONE] â†’ è‡ªåŠ¨å¾ªç¯
  â†‘     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â†“
  â””â”€â”€â”€â”€â”€â”€â”€ æŒ‰ä¸€æ¬¡ RUN åœæ­¢ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è¿ç»­é‡‡æ ·ï¼Œæ— éœ€æ‰‹åŠ¨é‡å¯ ğŸ”„
- âœ… é€‚åˆè§‚å¯Ÿé‡å¤äº‹ä»¶
- âœ… æ¯æ¬¡è§¦å‘åè‡ªåŠ¨é‡æ–°å¼€å§‹
- âš ï¸ capture_done åªæŒç»­ 1 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆè„‰å†²ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- ç›‘æ§è¿ç»­é‡å¤çš„ä¿¡å·
- å®æ—¶è·Ÿè¸ªä¿¡å·å˜åŒ–
- éœ€è¦å¤šæ¬¡é‡‡æ ·å¯¹æ¯”

---

## ğŸ“Š ä¿¡å·æ—¶åºå˜åŒ–

### åŸå§‹æ¨¡å¼æ—¶åº

```
trigger_enable: â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

capturing:      â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

triggered:      â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

capture_done:   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            â””â”€â”€â”€â”€â”€â”€â”˜
                            â†‘ ä¿æŒé«˜ç”µå¹³
```

---

### æ–°æ¨¡å¼æ—¶åº

```
trigger_enable: â”€â”€â”€â”€â”                         â”Œâ”€â”€
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

capturing:      â”€â”€â”€â”€â”  â”Œâ”€â”  â”Œâ”€â”  â”Œâ”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€ (å¾ªç¯)
                    â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜

triggered:      â”€â”€â”€â”€â”€â”  â”Œâ”  â”Œâ”  â”Œâ”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ (è„‰å†²)
                     â””â”€â”€â”˜â””â”€â”€â”˜â””â”€â”€â”˜â””â”€â”€â”˜

capture_done:   â”€â”€â”€â”€â”€â”€â” â”Œâ”  â”Œâ”  â”Œâ”  â”Œâ”€â”€â”€â”€â”€â”€â”€ (è„‰å†²)
                      â””â”€â”˜â””â”€â”€â”˜â””â”€â”€â”˜â””â”€â”€â”˜
                        â†‘ åªæŒç»­ 1 å‘¨æœŸ
```

**å…³é”®å˜åŒ–**ï¼š
- `capture_done` å˜æˆ**è„‰å†²ä¿¡å·**ï¼ˆé«˜ç”µå¹³åªæŒç»­ 1 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰
- æ¯æ¬¡é‡‡æ ·å®Œæˆåç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡é‡‡æ ·

---

## ğŸš¨ é‡è¦æ³¨æ„äº‹é¡¹

### âš ï¸ UART å‘é€çš„å½±å“

ç”±äº `uart_bram_streamer` çš„ `start` ä¿¡å·è¿æ¥åˆ° `capture_done`ï¼š

```verilog
uart_bram_streamer u_uart_streamer (
    .start(capture_done),  // â† æ¯æ¬¡ capture_done ä¸Šå‡æ²¿è§¦å‘å‘é€
    ...
);
```

**åœ¨æ–°çš„è¿ç»­æ¨¡å¼ä¸‹**ï¼š

```
æ¯æ¬¡é‡‡æ ·å®Œæˆ â†’ capture_done è„‰å†² â†’ UART å¼€å§‹å‘é€ 2054 å­—èŠ‚
                                   â†“
                            å‘é€éœ€è¦ ~178ms
                                   â†“
                        ä½†é‡‡æ ·å·²ç»ç»§ç»­è¿›è¡Œäº†ï¼
```

**å¯èƒ½çš„é—®é¢˜**ï¼š
1. âœ… **æ­£å¸¸æƒ…å†µ**ï¼šUART å‘é€å’Œé‡‡æ ·å¯ä»¥å¹¶è¡Œå·¥ä½œï¼Œäº’ä¸å¹²æ‰°
2. âš ï¸ **é«˜é¢‘è§¦å‘**ï¼šå¦‚æœè§¦å‘é—´éš” < 178msï¼ŒUART è¿˜åœ¨å‘é€ä¸Šä¸€å¸§ï¼Œæ–°çš„è§¦å‘åˆæ¥äº†
   - uart_bram_streamer ä¼šè¢«å¤šæ¬¡ start
   - å¯èƒ½å¯¼è‡´æ•°æ®æ··ä¹±

---

### ğŸ›¡ï¸ é¿å…é—®é¢˜çš„æ–¹æ³•

#### æ–¹æ³• 1ï¼šç¡®ä¿è§¦å‘é—´éš”è¶³å¤Ÿé•¿

**è®¾ç½®è§¦å‘æ¡ä»¶ä¸ºä½é¢‘äº‹ä»¶**ï¼Œä¾‹å¦‚ï¼š
- æŒ‰é”®è§¦å‘ï¼ˆäººå·¥æ“ä½œï¼Œé—´éš”é€šå¸¸ > 1 ç§’ï¼‰âœ…
- ä½é¢‘ä¿¡å·å˜åŒ–

**è¿™æ ·æ¯æ¬¡ UART å‘é€éƒ½èƒ½å®Œæˆ**ã€‚

---

#### æ–¹æ³• 2ï¼šæ·»åŠ  UART å¿™æ£€æµ‹ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦é«˜é¢‘è¿ç»­é‡‡æ ·ï¼Œå¯ä»¥ä¿®æ”¹ä»£ç ï¼š

```verilog
// åœ¨ fpga_top.v ä¸­æ·»åŠ 
wire uart_ready;
assign uart_ready = ~u_uart_streamer.busy;

// åªåœ¨ UART ç©ºé—²æ—¶æ‰å…è®¸æ–°çš„é‡‡æ ·å®Œæˆ
wire capture_done_gated;
assign capture_done_gated = capture_done & uart_ready;

// UART streamer ä½¿ç”¨é—¨æ§åçš„ä¿¡å·
uart_bram_streamer u_uart_streamer (
    .start(capture_done_gated),  // â† ä½¿ç”¨é—¨æ§ä¿¡å·
    ...
);
```

**ä½†è¿™ä¸æ˜¯å¿…é¡»çš„**ï¼Œå› ä¸ºï¼š
- uart_bram_streamer å†…éƒ¨æœ‰ `busy` æ ‡å¿—ä¿æŠ¤
- å¤šæ¬¡ start è„‰å†²ä¼šè¢«å¿½ç•¥ï¼ˆbusy=1 æ—¶ï¼‰

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨è¿ç»­é‡‡æ ·

1. **é…ç½®è§¦å‘æ¡ä»¶**ï¼ˆä¾‹å¦‚ï¼šé€šé“ 0 é«˜ç”µå¹³è§¦å‘ï¼‰
2. **æŒ‰ä¸€æ¬¡ RUN æŒ‰é’®**ï¼ˆbtn_trigger_enï¼‰
3. **é€»è¾‘åˆ†æå™¨å¼€å§‹è¿ç»­å·¥ä½œ**ï¼š
   ```
   ç­‰å¾…è§¦å‘ â†’ è§¦å‘ â†’ é‡‡æ · â†’ å®Œæˆ â†’ [è‡ªåŠ¨é‡å¤]
   ```

---

### åœæ­¢è¿ç»­é‡‡æ ·

**å†æŒ‰ä¸€æ¬¡ RUN æŒ‰é’®**ï¼š
- `trigger_enable_state` ç¿»è½¬ä¸º 0
- çŠ¶æ€æœºå›åˆ° `IDLE`
- åœæ­¢é‡‡æ · âœ‹

---

### æŸ¥çœ‹é‡‡æ ·ç»“æœï¼ˆä½¿ç”¨ ILAï¼‰

ç”±äºé‡‡æ ·æ˜¯è¿ç»­çš„ï¼ŒILA ä¹Ÿéœ€è¦è¿ç»­æ•è·ï¼š

#### é…ç½® ILA

**è§¦å‘æ¡ä»¶**ï¼š
```
Name: capture_done (probe6)
Operator: == R (Rising)
```

**æ•è·æ¨¡å¼**ï¼š
```
Settings â†’ Capture mode: ALWAYS
```

è¿™æ · ILA ä¼š**æ¯æ¬¡ capture_done è„‰å†²æ—¶éƒ½è§¦å‘**ï¼Œè¿ç»­åˆ·æ–°æ³¢å½¢ã€‚

---

## ğŸ“‹ æµ‹è¯•æ­¥éª¤

### 1ï¸âƒ£ é‡æ–°ç¼–è¯‘ FPGA

```
Run Synthesis â†’ Run Implementation â†’ Generate Bitstream
```

---

### 2ï¸âƒ£ ä¸‹è½½åˆ° FPGA

```
Open Hardware Manager â†’ Program Device
```

---

### 3ï¸âƒ£ é…ç½® ILA è¿ç»­æ•è·

åœ¨ Hardware Manager ä¸­ï¼š

1. **Trigger Setup**ï¼š
   ```
   probe6 (capture_done): == R (Rising)
   ```

2. **Settings**ï¼š
   ```
   Capture mode: ALWAYS
   ```

3. ç‚¹å‡» **â–¶ Run Trigger**

---

### 4ï¸âƒ£ å¯åŠ¨ FPGA è¿ç»­é‡‡æ ·

åœ¨ FPGA å¼€å‘æ¿ä¸Šï¼š

1. **æŒ‰ä¸€æ¬¡ RUN æŒ‰é’®**
2. **è§‚å¯Ÿ ILA æ³¢å½¢ä¸æ–­åˆ·æ–°** ğŸ”„
3. **æ¯æ¬¡è§¦å‘éƒ½ä¼šæ•è·æ–°çš„æ•°æ®**

---

### 5ï¸âƒ£ è§‚å¯Ÿæ³¢å½¢

ä½ åº”è¯¥çœ‹åˆ°ï¼š

```
probe4 (capturing):   â”Œâ”  â”Œâ”  â”Œâ”  â”Œâ”  â† ä¸æ–­å¾ªç¯
                      â””â”˜  â””â”˜  â””â”˜  â””â”˜

probe5 (triggered):   â”€â”  â”Œâ”  â”Œâ”  â”Œâ”  â† æ¯æ¬¡éƒ½è§¦å‘
                       â””â”€â”€â”˜â””â”€â”€â”˜â””â”€â”€â”˜

probe6 (capture_done):  â”Œâ”  â”Œâ”  â”Œâ”  â† è„‰å†²ä¿¡å·
                        â””â”˜  â””â”˜  â””â”˜

probe21 (uart_busy):   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â† æŒç»­å‘é€
                       (178ms é•¿)
```

---

## ğŸ¯ éªŒè¯æ¸…å•

å®Œæˆä¿®æ”¹åï¼Œç¡®è®¤ï¼š

- [ ] é‡æ–°ç¼–è¯‘å¹¶ä¸‹è½½ Bitstream
- [ ] ILA è®¾ç½®ä¸º `ALWAYS` æ•è·æ¨¡å¼
- [ ] è§¦å‘æ¡ä»¶è®¾ä¸º `capture_done` ä¸Šå‡æ²¿
- [ ] æŒ‰ä¸€æ¬¡ RUN æŒ‰é’®å¯åŠ¨
- [ ] ILA æ³¢å½¢ä¸æ–­åˆ·æ–° âœ…
- [ ] æ¯æ¬¡éƒ½èƒ½çœ‹åˆ°æ–°çš„é‡‡æ ·æ•°æ® âœ…
- [ ] UART busy ä¿¡å·æŒç»­é«˜ç”µå¹³ï¼ˆè¯´æ˜åœ¨å‘é€ï¼‰âœ…

---

## ğŸ”™ å¦‚ä½•æ¢å¤å•æ¬¡æ¨¡å¼

å¦‚æœä¸éœ€è¦è¿ç»­æ¨¡å¼ï¼Œå¯ä»¥è¿˜åŸä»£ç ï¼š

```verilog
DONE: begin
    wr_en        <= 1'b0;
    capturing    <= 1'b0;
    capture_done <= 1'b1;

    if (!trigger_enable) begin
        state <= IDLE;
        edge_triggered_latch <= 0;
    end
    // åˆ é™¤ else åˆ†æ”¯ï¼Œåœç•™åœ¨ DONE çŠ¶æ€
end
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [src/logic_analyzer_core.v](../src/logic_analyzer_core.v) - é‡‡æ ·æ ¸å¿ƒï¼ˆå·²ä¿®æ”¹ï¼‰
- [src/fpga_top.v](../src/fpga_top.v) - é¡¶å±‚æ–‡ä»¶
- [docs/ILA_QUICK_START.md](ILA_QUICK_START.md) - ILA ä½¿ç”¨æŒ‡å—

---

**ç°åœ¨é€»è¾‘åˆ†æå™¨æ”¯æŒè¿ç»­è‡ªåŠ¨é‡‡æ ·äº†ï¼** ğŸ‰
