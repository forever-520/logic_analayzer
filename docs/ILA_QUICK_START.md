# ğŸš€ ILA è°ƒè¯•å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

## âœ… å‡†å¤‡å·¥ä½œï¼ˆå·²å®Œæˆï¼‰

- [x] uart_tx å¼•è„šçº¦æŸå·²æ·»åŠ åˆ° `src/logic_analyzer.xdc`
- [x] UART è°ƒè¯•ä¿¡å·å·²æ·»åŠ åˆ° `src/fpga_top.v`ï¼ˆä½¿ç”¨ MARK_DEBUGï¼‰

---

## ğŸ“ éœ€è¦ä½ ç¡®è®¤çš„äº‹é¡¹

### æ£€æŸ¥ uart_tx å¼•è„šå·

æ‰“å¼€ `src/logic_analyzer.xdc` ç¬¬ 63 è¡Œï¼š

```tcl
set_property PACKAGE_PIN V18 [get_ports uart_tx]
```

**è¯·æ ¹æ®ä½ çš„å¼€å‘æ¿ç¡®è®¤æˆ–ä¿®æ”¹ `V18` å¼•è„šå·**ï¼š

- æŸ¥çœ‹å¼€å‘æ¿åŸç†å›¾
- æ‰¾åˆ° UART TX æˆ– USB-UART èŠ¯ç‰‡çš„ TX å¼•è„š
- å¦‚æœä½¿ç”¨å¤–éƒ¨ CH340ï¼Œå¯ä»¥ä»»é€‰ç©ºé—² IO

å¸¸è§å¼€å‘æ¿å‚è€ƒï¼š
- **PYNQ-Z2**: æŸ¥æ‰¾åŸç†å›¾ä¸­çš„ `UART_TXD` ä¿¡å·
- **Zynq-7000 ç³»åˆ—**: é€šå¸¸åœ¨ `PS` ç«¯æˆ– `PL` ç«¯éƒ½æœ‰ UART
- **è‡ªåˆ¶æ¿**: æ ¹æ®å®é™…è¿çº¿ç¡®å®š

---


## ğŸ”¨ Vivado æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1ï¼šæ‰“å¼€é¡¹ç›®

1. å¯åŠ¨ Vivado 2020.2
2. æ‰“å¼€é¡¹ç›®ï¼š`E:\fpga_class\vivado\logic_analyzer\logic_analyzer\logic_analyzer.xpr`

---

### æ­¥éª¤ 2ï¼šè¿è¡Œç»¼åˆ

1. ç‚¹å‡»å·¦ä¾§ **Flow Navigator â†’ Run Synthesis**
2. ç­‰å¾…ç»¼åˆå®Œæˆï¼ˆçº¦ 2-5 åˆ†é’Ÿï¼‰
3. å¦‚æœå¼¹å‡ºå¯¹è¯æ¡†ï¼Œé€‰æ‹© **Cancel**ï¼ˆä¸ç”¨é©¬ä¸Šæ‰“å¼€ï¼‰

**æ£€æŸ¥ ILA æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ**ï¼š
- ç»¼åˆå®Œæˆåï¼Œç‚¹å‡» **Open Synthesized Design**
- åœ¨ **Sources** çª—å£ä¸­ï¼Œæœç´¢ `dbg_hub` æˆ– `ila`
- åº”è¯¥èƒ½çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ ILA æ ¸å¿ƒ

---

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹ ILA æ¢é’ˆ

**æ–¹æ³• Aï¼šé€šè¿‡ Synthesized Design**

1. **Open Synthesized Design**
2. ç‚¹å‡» **Window â†’ Debug**
3. åœ¨ **Debug** çª—å£ä¸­æŸ¥çœ‹ MARK_DEBUG ä¿¡å·ï¼š

ä½ åº”è¯¥çœ‹åˆ°ä»¥ä¸‹ 10 ä¸ªè°ƒè¯•ä¿¡å·ï¼š

| ä¿¡å·å | ä½å®½ | è¯´æ˜ |
|--------|------|------|
| `debug_tx_data` | [7:0] | å‘é€çš„å­—èŠ‚æ•°æ® |
| `debug_tx_valid` | 1 | å‘é€è¯·æ±‚ä¿¡å· |
| `debug_tx_ready` | 1 | UART ç©ºé—²æ ‡å¿— |
| `debug_uart_busy` | 1 | UART å‘é€å¿™ |
| `debug_rd_addr` | [10:0] | BRAM è¯»åœ°å€ |
| `debug_streamer_state` | [2:0] | çŠ¶æ€æœºçŠ¶æ€ |
| `debug_uart_tx` | 1 | ä¸²å£ TX å¼•è„š |
| `debug_capture_done` | 1 | é‡‡æ ·å®Œæˆæ ‡å¿— |
| `debug_tx_state` | [1:0] | uart_tx çŠ¶æ€æœº |
| `debug_rd_data` | [7:0] | BRAM è¯»æ•°æ® |

---

**æ–¹æ³• Bï¼šé€šè¿‡ TCL å‘½ä»¤**

åœ¨ Vivado **Tcl Console** ä¸­è¿è¡Œï¼š

```tcl
# æŸ¥çœ‹æ‰€æœ‰ MARK_DEBUG ä¿¡å·
get_nets -hier -filter {MARK_DEBUG == TRUE}
```

åº”è¯¥è¾“å‡ºç±»ä¼¼ï¼š
```
fpga_top_i/debug_tx_data[0]
fpga_top_i/debug_tx_data[1]
...
fpga_top_i/debug_uart_busy
```

---

### æ­¥éª¤ 4ï¼šè¿è¡Œå®ç°å’Œç”Ÿæˆ Bitstream

1. **Run Implementation**
   - ç‚¹å‡» **Flow Navigator â†’ Run Implementation**
   - ç­‰å¾…å®Œæˆï¼ˆçº¦ 5-10 åˆ†é’Ÿï¼‰

2. **Generate Bitstream**
   - ç‚¹å‡» **Flow Navigator â†’ Generate Bitstream**
   - ç­‰å¾…å®Œæˆï¼ˆçº¦ 2-3 åˆ†é’Ÿï¼‰

3. **ç¡®è®¤ç”Ÿæˆçš„æ–‡ä»¶**
   - Bitstream: `*.bit`
   - Debug Probes: `*.ltx`ï¼ˆåŒ…å« ILA æ¢é’ˆå®šä¹‰ï¼‰

---

### æ­¥éª¤ 5ï¼šä¸‹è½½åˆ° FPGA

1. **è¿æ¥å¼€å‘æ¿**
   - USB JTAG çº¿è¿æ¥åˆ°ç”µè„‘
   - å¼€å‘æ¿ä¸Šç”µ

2. **æ‰“å¼€ Hardware Manager**
   - ç‚¹å‡» **Flow â†’ Open Hardware Manager**
   - ç‚¹å‡» **Open Target â†’ Auto Connect**

3. **Program Device**
   - å³é”®ç‚¹å‡» FPGA è®¾å¤‡ï¼ˆä¾‹å¦‚ `xc7z010_1`ï¼‰
   - é€‰æ‹© **Program Device...**
   - Bitstream file: è‡ªåŠ¨é€‰æ‹©ç”Ÿæˆçš„ `.bit` æ–‡ä»¶
   - Debug probes file: è‡ªåŠ¨é€‰æ‹© `.ltx` æ–‡ä»¶
   - âœ… **å‹¾é€‰ "Refresh device after programming"**
   - ç‚¹å‡» **Program**

---

### æ­¥éª¤ 6ï¼šé…ç½® ILA è§¦å‘

ä¸‹è½½å®Œæˆåï¼ŒHardware Manager ä¼šè‡ªåŠ¨æ˜¾ç¤º ILA è°ƒè¯•çª—å£ã€‚

#### ğŸ¯ **æ¨èè§¦å‘é…ç½®ï¼šæ•è·å‘é€å¼€å§‹**

**è§¦å‘æ¡ä»¶**ï¼š`debug_uart_busy` ä¸Šå‡æ²¿

åœ¨ **Trigger Setup** çª—å£ä¸­ï¼š

```
debug_uart_busy:  [  ] ==  [â—] R (Rising)
```

**å«ä¹‰**ï¼šå½“ UART å¼€å§‹å‘é€ï¼ˆbusy ä» 0â†’1ï¼‰æ—¶è§¦å‘æ•è·

---

#### ğŸ” **æŸ¥çœ‹å…³é”®ä¿¡å·æ³¢å½¢**

**æ¨èæ·»åŠ åˆ°æ³¢å½¢çª—å£çš„ä¿¡å·**ï¼š

```
debug_capture_done       // é‡‡æ ·å®Œæˆæ ‡å¿—
debug_uart_busy          // UART å‘é€å¿™
debug_tx_valid           // å‘é€è¯·æ±‚
debug_tx_data[7:0]       // å‘é€çš„å­—èŠ‚ â­ é‡ç‚¹
debug_rd_addr[10:0]      // BRAM è¯»åœ°å€
debug_streamer_state[2:0]// çŠ¶æ€æœº
debug_uart_tx            // ä¸²å£æ³¢å½¢
```

---

### æ­¥éª¤ 7ï¼šè¿è¡Œæ•è·

1. **è®¾ç½®æ•è·æ·±åº¦**
   - Trigger Position: `512` samples
   - Window Data Depth: `8192` samples
   - å«ä¹‰ï¼šæ•è·è§¦å‘å‰ 512 ä¸ªé‡‡æ ·ç‚¹ï¼Œè§¦å‘å 7680 ä¸ªé‡‡æ ·ç‚¹

2. **å¯åŠ¨æ•è·**
   - ç‚¹å‡»å·¥å…·æ çš„ **â–¶ Run Trigger** æŒ‰é’®
   - ILA è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆæ˜¾ç¤º "Waiting for Trigger..."ï¼‰

3. **è§¦å‘ FPGA é‡‡æ ·**
   - åœ¨å¼€å‘æ¿ä¸ŠæŒ‰ä¸‹ **RUN æŒ‰é’®**ï¼ˆbtn_trigger_enï¼‰
   - ç­‰å¾…é€»è¾‘åˆ†æå™¨é‡‡æ ·å®Œæˆ
   - UART å¼€å§‹å‘é€
   - ILA ç«‹å³è§¦å‘å¹¶æ•è·æ•°æ® âœ…

---

## ğŸ” æ³¢å½¢åˆ†æ

### æŸ¥çœ‹å‘é€æ•°æ®

æ•è·å®Œæˆåï¼Œåœ¨æ³¢å½¢çª—å£ä¸­ï¼š

1. **å±•å¼€ debug_tx_data**ï¼š
   - å³é”® â†’ **Radix â†’ Hexadecimal**ï¼ˆæ˜¾ç¤ºåå…­è¿›åˆ¶ï¼‰

2. **è¿‡æ»¤æœ‰æ•ˆæ•°æ®**ï¼š
   - åªçœ‹ `debug_tx_valid = 1` æ—¶çš„ `debug_tx_data`
   - å¯ä»¥æ·»åŠ  triggerï¼š`debug_tx_valid == 1`

3. **éªŒè¯å¸§å¤´**ï¼š

é¢„æœŸçœ‹åˆ°çš„æ•°æ®åºåˆ—ï¼š

| Time | debug_tx_valid | debug_tx_data | è¯´æ˜ |
|------|----------------|---------------|------|
| T0   | 0              | xx            | ç©ºé—² |
| T1   | 1              | **55**        | å¸§å¤´å­—èŠ‚ 1 âœ… |
| T2   | 1              | **AA**        | å¸§å¤´å­—èŠ‚ 2 âœ… |
| T3   | 1              | **00**        | é•¿åº¦ä½å­—èŠ‚ (LEN_L) |
| T4   | 1              | **08**        | é•¿åº¦é«˜å­—èŠ‚ (LEN_H) â†’ 0x0800 = 2048 âœ… |
| T5   | 1              | 01            | è§¦å‘ç´¢å¼•ä½å­—èŠ‚ |
| T6   | 1              | 00            | è§¦å‘ç´¢å¼•é«˜å­—èŠ‚ |
| T7   | 1              | 21            | æ•°æ®å­—èŠ‚ 0 |
| T8   | 1              | 21            | æ•°æ®å­—èŠ‚ 1 |
| ...  | 1              | ...           | åç»­ 2046 å­—èŠ‚ |

---

### éªŒè¯åœ°å€é€’å¢

æŸ¥çœ‹ `debug_rd_addr`ï¼š

1. åˆ‡æ¢ Radix ä¸º **Unsigned Decimal**
2. åº”è¯¥çœ‹åˆ°åœ°å€ä» `0` é€’å¢åˆ° `2047`
3. æ¯æ¬¡ `debug_tx_valid = 1` æ—¶ï¼Œåœ°å€å¢åŠ  1

---

### æŸ¥çœ‹çŠ¶æ€æœº

`debug_streamer_state` åº”è¯¥ç»å†ï¼š

```
0 (S_IDLE) â†’ 1 (S_HDR) â†’ 2 (S_PREF) â†’ 3 (S_DATA) â†’ 4 (S_DONE) â†’ 0
```

---

### æŸ¥çœ‹ UART æ³¢å½¢

æ”¾å¤§æ—¶é—´è½´ï¼ŒæŸ¥çœ‹ `debug_uart_tx` çš„å•ä¸ªå­—èŠ‚æ³¢å½¢ï¼š

```
       â”ŒIDLE
       â”‚ â”ŒSTART
       â”‚ â”‚  â”ŒD0 â”ŒD1    â”ŒD7 â”ŒSTOP
uart_txâ”‚ â”‚  â”‚   â”‚  ... â”‚   â”‚ â”ŒIDLE
  â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”˜ â”Œâ”€â”˜ â”Œâ”€â”€â”€ â””â”€â” â””â”€â”´â”€â”€â”€â”€â”€
             â””â”€â”€â”€â”˜       â””â”€â”€â”€
        â†â”€ 434 clocks â”€â†’ (æ¯ä¸ª bit)
```

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆ ILA è°ƒè¯•åï¼Œç¡®è®¤ä»¥ä¸‹æ‰€æœ‰é¡¹ï¼š

- [ ] ILA æˆåŠŸè§¦å‘å¹¶æ•è·æ•°æ®
- [ ] `debug_tx_data` å‰ 6 å­—èŠ‚ä¸ºï¼š`55 AA 00 08 XX XX` âœ…
- [ ] `debug_rd_addr` ä» 0 é€’å¢åˆ° 2047 âœ…
- [ ] `debug_uart_busy` æŒç»­é«˜ç”µå¹³çº¦ 178ms âœ…
- [ ] `debug_streamer_state` æ­£å¸¸è·³è½¬ âœ…
- [ ] `debug_uart_tx` æ³¢å½¢ç¬¦åˆ 8N1 æ ¼å¼ âœ…

**å¦‚æœä»¥ä¸Šå…¨éƒ¨é€šè¿‡ï¼ŒFPGA å†…éƒ¨é€»è¾‘å®Œå…¨æ­£ç¡®ï¼** ğŸ‰

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: Hardware Manager ä¸­çœ‹ä¸åˆ° ILA

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ Program Device æ—¶æ˜¯å¦åŠ è½½äº† `.ltx` æ–‡ä»¶
2. é‡æ–°ç”Ÿæˆ Bitstreamï¼š**Write Bitstream Settings â†’ Debug Probes File â†’ å‹¾é€‰**
3. ç¡®è®¤ `src/fpga_top.v` ä¸­çš„ `MARK_DEBUG` ä¿¡å·æ²¡æœ‰è¢«ç»¼åˆä¼˜åŒ–æ‰

---

### Q2: ILA ä¸è§¦å‘

**è§£å†³æ–¹æ³•**ï¼š
1. æ”¹ç”¨ **Trigger Immediately**ï¼ˆç«‹å³è§¦å‘ï¼Œä¸è®¾è§¦å‘æ¡ä»¶ï¼‰
2. æ£€æŸ¥ `debug_capture_done` æ˜¯å¦å˜ä¸º 1ï¼ˆè¯´æ˜é‡‡æ ·å®Œæˆï¼‰
3. æ£€æŸ¥ `debug_uart_busy` æ˜¯å¦æœ‰ä¸Šå‡æ²¿

---

### Q3: debug_tx_data æ˜¾ç¤ºçš„å€¼ä¸å¯¹

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `sw_test_pattern` å¼€å…³è®¾ç½®
2. æ·»åŠ æ¢é’ˆç›‘æ§ `debug_rd_data`ï¼ˆBRAM è¯»å‡ºçš„æ•°æ®ï¼‰
3. å¯¹æ¯” `debug_rd_data` å’Œ `debug_tx_data` æ˜¯å¦ä¸€è‡´

---

## ğŸ“ å‚è€ƒæ–‡æ¡£

- **è¯¦ç»† ILA é…ç½®æŒ‡å—**: [docs/ILA_SETUP_GUIDE.md](ILA_SETUP_GUIDE.md)
- **UART è°ƒè¯•å®Œæ•´æŒ‡å—**: [docs/UART_DEBUG_GUIDE.md](UART_DEBUG_GUIDE.md)
- **uart_tx æ¨¡å—æ³¨é‡Š**: [src/uart_tx.v](../src/uart_tx.v)

---

## ğŸš€ ä¸‹ä¸€æ­¥

ILA éªŒè¯é€šè¿‡åï¼š

1. **å®é™…ç¡¬ä»¶é€šä¿¡æµ‹è¯•**ï¼š
   - è¿æ¥ CH340 æ¨¡å—
   - ä½¿ç”¨ Python è„šæœ¬æ¥æ”¶æ•°æ®
   - å‚è€ƒ [docs/UART_DEBUG_GUIDE.md](UART_DEBUG_GUIDE.md)

2. **å¼€å‘ä¸Šä½æœºè½¯ä»¶**ï¼š
   - æ³¢å½¢æ˜¾ç¤º
   - æ•°æ®åˆ†æ
   - å¯¼å‡ºåŠŸèƒ½

**ç¥è°ƒè¯•é¡ºåˆ©ï¼** ğŸ‰
